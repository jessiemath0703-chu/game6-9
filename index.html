<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math | æ€æ¨£è§£é¡Œå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; touch-action: manipulation; }
        .font-brand { font-family: 'Baloo 2', cursive; }
        .jessie-header { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background-color: white; padding: 0.75rem 1rem; position: sticky; top: 0; z-index: 50; }
        .logo-circle { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #F59E0B; background-color: transparent; object-fit: contain; padding: 2px; }
        .brand-text { color: #2c3e50; font-size: 1.5rem; font-weight: 800; margin-left: 10px; letter-spacing: 0.5px; }
        .btn-primary { background-color: #3B82F6; color: white; border-radius: 9999px; padding: 0.5rem 1.5rem; font-weight: bold; transition: transform 0.1s; box-shadow: 0 4px 0 #2563EB; }
        .btn-primary:active { transform: translateY(4px); box-shadow: none; }
        .btn-nav { border: 2px solid #E5E7EB; border-radius: 9999px; padding: 0.4rem 1rem; color: #374151; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-nav:hover { background-color: #F3F4F6; border-color: #3B82F6; color: #3B82F6; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-card { background: white; border-left: 5px solid #F59E0B; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* æ’è¡Œæ¦œç±¤é æ¨£å¼ */
        .tab-btn { padding: 8px 16px; border-radius: 8px 8px 0 0; font-weight: bold; color: #6B7280; background: #E5E7EB; margin-right: 4px; transition: all 0.2s; }
        .tab-btn.active { background: white; color: #3B82F6; border-top: 3px solid #3B82F6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="jessie-header flex justify-between items-center">
        <div class="flex items-center cursor-pointer" onclick="goHome()">
            <img src="JESSIEMATH-Q.png" alt="Jessie Logo" class="logo-circle">
            <span class="brand-text font-brand">Jessie Math</span>
        </div>
        <div class="flex gap-2 sm:gap-4">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="btn-nav">
                <i class="fa-solid fa-house"></i><span class="hidden sm:inline">é¦–é </span>
            </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="btn-nav bg-blue-50 border-blue-200 text-blue-600">
                <i class="fa-solid fa-gamepad"></i><span class="hidden sm:inline">éŠæˆ²å¤§å»³</span>
            </a>
        </div>
    </header>

    <main id="game-container" class="flex-grow container mx-auto p-4 max-w-4xl flex flex-col justify-center items-center">
        
        <div id="screen-login" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">æ€æ¨£è§£é¡Œå¤§å†’éšª</h1>
            <p class="text-gray-500 mb-6">è¼¸å…¥åå­—ï¼ŒæŒ‘æˆ°éš¨æ©Ÿè®ŠåŒ–çš„æ•¸å­¸é—œå¡ï¼</p>
            <div class="mb-6">
                <label class="block text-left text-gray-700 font-bold mb-2">è«‹è¼¸å…¥åå­—ï¼š</label>
                <input type="text" id="player-name" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸å°å¤©æ‰" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none text-lg">
            </div>
            <button onclick="checkNameAndStart()" class="w-full btn-primary text-xl">é–‹å§‹å†’éšª <i class="fa-solid fa-arrow-right ml-2"></i></button>
        </div>

        <div id="screen-level-select" class="w-full hidden fade-in flex flex-col gap-8">
            
            <div>
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">é¸æ“‡æŒ‘æˆ°é—œå¡</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button onclick="selectLevel(1)" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg border-b-4 border-green-500 hover:-translate-y-1 transition text-left">
                        <div class="text-green-600 text-sm font-bold mb-1">ç¬¬ä¸€é—œï½œå’Œä¸è®Š</div>
                        <h3 class="text-xl font-bold mb-2">ä¸è®Šçš„ç¥•å¯†</h3>
                        <p class="text-gray-500 text-sm">è½‰ç­ã€åˆ†è£ã€æ›æ‰‹æ‹¿ï¼Œç¸½æ•¸è®Šäº†å—ï¼Ÿ</p>
                    </button>
                    <button onclick="selectLevel(2)" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg border-b-4 border-blue-500 hover:-translate-y-1 transition text-left">
                        <div class="text-blue-600 text-sm font-bold mb-1">ç¬¬äºŒé—œï½œå·®ä¸è®Š</div>
                        <h3 class="text-xl font-bold mb-2">å·®å€¼å®ˆé–€äºº</h3>
                        <p class="text-gray-500 text-sm">å¹´é½¡ã€çˆ¬æ¨“æ¢¯ã€åŒåŠ åŒæ¸›ã€‚</p>
                    </button>
                    <button onclick="selectLevel(3)" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg border-b-4 border-purple-500 hover:-translate-y-1 transition text-left">
                        <div class="text-purple-600 text-sm font-bold mb-1">ç¬¬ä¸‰é—œï½œå•†ä¸è®Š</div>
                        <h3 class="text-xl font-bold mb-2">ç¸®æ”¾è¿·å®®</h3>
                        <p class="text-gray-500 text-sm">é£Ÿè­œæ¯”ä¾‹ã€åœ°åœ–ç¸®æ”¾ã€ç…§ç‰‡è®Šå¤§ã€‚</p>
                    </button>
                    <button onclick="selectLevel(4)" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg border-b-4 border-red-500 hover:-translate-y-1 transition text-left">
                        <div class="text-red-600 text-sm font-bold mb-1">ç¬¬å››é—œï½œç©ä¸è®Š</div>
                        <h3 class="text-xl font-bold mb-2">äº¤æ˜“å¸‚å ´</h3>
                        <p class="text-gray-500 text-sm">é¢ç©å›ºå®šã€å·¥ç¨‹äººæ•¸ã€é€Ÿåº¦æ™‚é–“ã€‚</p>
                    </button>
                    <button onclick="selectLevel(5)" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg border-b-4 border-yellow-500 hover:-translate-y-1 transition text-left col-span-1 md:col-span-2 lg:col-span-1">
                        <div class="text-yellow-600 text-sm font-bold mb-1">ç¬¬äº”é—œï½œé›å…”å•é¡Œ</div>
                        <h3 class="text-xl font-bold mb-2">åµæŸ¥ä»»å‹™</h3>
                        <p class="text-gray-500 text-sm">è»Šè¼ªã€ç¥¨åƒ¹ã€è…³æ•¸ï¼Œå‡è¨­æ³•è§£é¡Œï¼</p>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 max-w-3xl mx-auto w-full">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ†</span>
                    <h3 class="text-xl font-bold text-gray-800">è‹±é›„æ¦œ</h3>
                </div>
                
                <div class="flex overflow-x-auto border-b border-gray-200 mb-4 no-scrollbar">
                    <button onclick="renderLeaderboardTab(1)" id="tab-1" class="tab-btn active">ç¬¬ä¸€é—œ</button>
                    <button onclick="renderLeaderboardTab(2)" id="tab-2" class="tab-btn">ç¬¬äºŒé—œ</button>
                    <button onclick="renderLeaderboardTab(3)" id="tab-3" class="tab-btn">ç¬¬ä¸‰é—œ</button>
                    <button onclick="renderLeaderboardTab(4)" id="tab-4" class="tab-btn">ç¬¬å››é—œ</button>
                    <button onclick="renderLeaderboardTab(5)" id="tab-5" class="tab-btn">ç¬¬äº”é—œ</button>
                </div>

                <div id="select-screen-lb-list" class="min-h-[150px]">
                    </div>
            </div>
        </div>

        <div id="modal-intro" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="bg-white p-8 rounded-2xl max-w-md w-11/12 text-center animate-bounce-in shadow-2xl">
                <div id="intro-icon" class="text-4xl mb-4">ğŸŒŸ</div>
                <h3 id="intro-title" class="text-2xl font-bold mb-4">é—œå¡èªªæ˜</h3>
                <p id="intro-desc" class="text-gray-600 mb-6 text-left leading-relaxed"></p>
                <div class="flex flex-col gap-2">
                     <p class="text-sm text-gray-400 mb-2">é¸æ“‡é›£åº¦ï¼š</p>
                     <div class="flex justify-center gap-4 mb-4">
                         <button onclick="startGame('normal')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 font-bold transform active:scale-95 transition">æ™®é€š</button>
                         <button onclick="startGame('fast')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-bold transform active:scale-95 transition">å¿«é€ŸæŒ‘æˆ°</button>
                     </div>
                </div>
                <button onclick="closeIntro()" class="text-gray-400 underline text-sm hover:text-gray-600">è¿”å›é¸å–®</button>
            </div>
        </div>

        <div id="screen-game" class="w-full max-w-2xl hidden flex flex-col h-full">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-4">
                <div class="flex items-center gap-4">
                    <div class="text-gray-600"><i class="fa-solid fa-clock mr-1"></i> <span id="game-timer">00:00</span></div>
                    <div class="text-orange-500 font-bold"><i class="fa-solid fa-star mr-1"></i> <span id="game-score">0</span></div>
                </div>
                <button onclick="pauseGame()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full hover:bg-gray-200">
                    <i class="fa-solid fa-pause text-gray-600"></i>
                </button>
            </div>
            <div id="question-area" class="bg-white p-6 rounded-2xl shadow-lg flex-grow flex flex-col justify-center items-center text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gray-100">
                    <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="question-content" class="w-full"></div>
            </div>
            <div id="controls-area" class="mt-4 grid grid-cols-2 gap-4"></div>
        </div>

        <div id="modal-pause" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50 hidden">
            <h2 class="text-3xl font-bold mb-8 text-gray-800">éŠæˆ²æš«åœ</h2>
            <button onclick="resumeGame()" class="btn-primary mb-4 w-48"><i class="fa-solid fa-play mr-2"></i> ç¹¼çºŒéŠæˆ²</button>
            <button onclick="quitGame()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-full font-bold w-48 hover:bg-gray-300"><i class="fa-solid fa-house mr-2"></i> å›åˆ°é¸å–®</button>
        </div>

        <div id="screen-result" class="w-full max-w-md hidden text-center fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <div class="text-6xl mb-4">ğŸ†</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
                <p class="text-gray-500 mb-6">åšå¾—å¥½ï¼Œ<span id="result-name" class="font-bold text-blue-600"></span>ï¼</p>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-orange-50 p-4 rounded-xl">
                        <div class="text-sm text-gray-500">æœ€çµ‚å¾—åˆ†</div>
                        <div id="result-score" class="text-3xl font-bold text-orange-500">0</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <div class="text-sm text-gray-500">èŠ±è²»æ™‚é–“</div>
                        <div id="result-time" class="text-3xl font-bold text-blue-500">00:00</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="quitGame()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold">è¿”å›é¸å–®æŸ¥çœ‹æ’å</button>
                    <button onclick="restartLevel()" class="flex-1 btn-primary py-3 rounded-lg font-bold">å†ç©ä¸€æ¬¡</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- æ“´å……å¾Œçš„è±å¯Œé¡Œåº« (æ¯é—œç´„ 7-8 é¡Œ) ---
        const levels = {
            1: {
                title: "ç¬¬ä¸€é—œï½œå’Œä¸è®Š",
                desc: "æ ¸å¿ƒè§€å¿µï¼šæ±è¥¿åªæ˜¯æ›ä½ç½®æˆ–æ›åˆ†æ³•ï¼Œç¸½é‡ä¸æœƒè®Šã€‚<br>è«‹æ³¨æ„çœ‹æ¸…æ¥šï¼Œç¸½æ•¸åˆ°åº•æœ‰æ²’æœ‰è®Šï¼Ÿ",
                icon: "ğŸ¬",
                data: [
                    { q: "å°æ˜çµ¦å°è¯ 50 å…ƒï¼Œè«‹å•å…©äººçš„ã€ŒéŒ¢æ•¸ç¸½å’Œã€ï¼Ÿ", type: "choice", options: ["è®Šå¤š", "è®Šå°‘", "ä¸è®Š"], ans: 2 },
                    { q: "ä¸€å¤§ç“¶æœæ± 1000mlï¼Œå€’é€²æ¯å­å¾Œï¼Œæœæ±ã€Œç¸½é‡ã€æ˜¯ï¼Ÿ", type: "choice", options: ["è®Šå¤š", "ä¸è®Š", "è®Šå°‘"], ans: 1 },
                    { q: "A ç­æœ‰ 20 äººï¼ŒB ç­æœ‰ 20 äººã€‚A ç­è½‰ 5 äººå» B ç­ï¼Œå…©ç­å…±æœ‰å¹¾äººï¼Ÿ", type: "input", ans: 40 }, 
                    { q: "ä¸€å †ç³–æœåŸæœ¬æ¯åŒ…è£ 6 é¡†ï¼Œæ”¹æˆæ¯åŒ…è£ 4 é¡†ï¼Œç³–æœã€Œç¸½é¡†æ•¸ã€ï¼Ÿ", type: "choice", options: ["è®Šå¤š", "è®Šå°‘", "ä¸è®Š"], ans: 2 },
                    { q: "å·¦æ‰‹ 3 å€‹è˜‹æœï¼Œå³æ‰‹ 2 å€‹ã€‚å·¦æ‰‹çµ¦å³æ‰‹ 1 å€‹ï¼Œé›™æ‰‹å…±æœ‰å¹¾å€‹è˜‹æœï¼Ÿ", type: "input", ans: 5 },
                    { q: "æ¨¹ä¸Šæœ‰ 5 éš»é³¥ï¼Œé£›ä¾† 2 éš»åˆé£›èµ° 2 éš»ï¼Œæ¨¹ä¸Šé³¥çš„ç¸½æ•¸ï¼Ÿ", type: "choice", options: ["è®Šå¤š", "è®Šå°‘", "ä¸è®Š"], ans: 2 },
                    { q: "æŠŠä¸€å€‹å¤§è›‹ç³•åˆ‡æˆ 8 å°å¡Šï¼Œè›‹ç³•çš„ã€Œç¸½é‡é‡ã€æœƒï¼Ÿ", type: "choice", options: ["è®Šè¼•", "ä¸è®Š", "è®Šé‡"], ans: 1 },
                    { q: "æ°´ç¼¸è£¡æœ‰æ°´ï¼ŒæŠŠä¸€é¡†çŸ³é ­ä¸Ÿé€²å»ï¼Œæ°´çš„é«”ç©åŠ ä¸ŠçŸ³é ­é«”ç©ï¼Œç¸½é«”ç©æœƒï¼Ÿ", type: "choice", options: ["å¢åŠ ", "æ¸›å°‘", "ä¸è®Š"], ans: 0 } // æ³¨æ„ï¼šé€™è£¡æ˜¯å•ç¸½é«”ç©(æ°´+çŸ³)å°æ–¼æº¢å‡ºå‰çš„æ¦‚å¿µï¼Œé€™é¡Œæ˜¯é™·é˜±é¡Œï¼Œç¸½ç‰©è³ªé‡å¢åŠ äº†çŸ³é ­ã€‚
                ]
            },
            2: {
                title: "ç¬¬äºŒé—œï½œå·®ä¸è®Š",
                desc: "æ ¸å¿ƒè§€å¿µï¼šå…©é‚Šä¸€èµ·åŠ æˆ–ä¸€èµ·æ¸›ç›¸åŒçš„æ•¸é‡ï¼Œå·®è·ç¶­æŒä¸è®Šã€‚",
                icon: "âš–ï¸",
                data: [
                    { q: "ä»Šå¹´çˆ¸çˆ¸æ¯”æˆ‘å¤§ 25 æ­²ï¼Œ10 å¹´å¾Œï¼Œçˆ¸çˆ¸æ¯”æˆ‘å¤§å¹¾æ­²ï¼Ÿ", type: "input", ans: 25 },
                    { q: "å…©äººä¸€èµ·çˆ¬æ¨“æ¢¯ï¼Œéƒ½å¾€ä¸Šçˆ¬äº† 5 æ ¼ï¼Œå…©äººä¹‹é–“çš„ã€Œè·é›¢ã€ï¼Ÿ", type: "choice", options: ["è®Šé ", "è®Šè¿‘", "ä¸è®Š"], ans: 2 },
                    { q: "å°æ˜è€ƒ 80 åˆ†ï¼Œå°è¯è€ƒ 70 åˆ†ã€‚è€å¸«å„åŠ  5 åˆ†ã€‚å…©äººçš„ã€Œåˆ†å·®ã€æ˜¯å¤šå°‘ï¼Ÿ", type: "input", ans: 10 },
                    { q: "å¤©ç§¤å·¦é‚Š 15ï¼Œå³é‚Š 10ã€‚è¦ç¶­æŒå·®ä¸è®Šï¼Œå·¦é‚ŠåŠ  3ï¼Œå³é‚Šè¦ï¼Ÿ", type: "choice", options: ["æ¸› 3", "åŠ  3", "ä¸å‹•"], ans: 1 },
                    { q: "å…©å°é›»æ¢¯åŸæœ¬å·® 3 å€‹æ¨“å±¤ï¼ŒåŒæ™‚ä¸Šå‡ 2 å±¤æ¨“ï¼Œç¾åœ¨å·®å¹¾æ¨“ï¼Ÿ", type: "input", ans: 3 },
                    { q: "éŒ¢åŒ…Aæœ‰ 50 å…ƒï¼ŒéŒ¢åŒ…Bæœ‰ 30 å…ƒã€‚å„èŠ±æ‰ 10 å…ƒï¼Œå…©éŒ¢åŒ…çš„å·®é¡ï¼Ÿ", type: "choice", options: ["ä¸è®Š", "è®Šå¤§", "è®Šå°"], ans: 0 },
                    { q: "æ“å ´è·‘æ­¥ï¼Œç”²é ˜å…ˆä¹™ 10 å…¬å°ºã€‚å…©äººé€Ÿåº¦ä¸€æ¨£ç¹¼çºŒè·‘ï¼Œè·é›¢æœƒï¼Ÿ", type: "choice", options: ["æ‹‰å¤§", "ç¸®å°", "ä¸è®Š"], ans: 2 }
                ]
            },
            3: {
                title: "ç¬¬ä¸‰é—œï½œå•†ä¸è®Š",
                desc: "æ ¸å¿ƒè§€å¿µï¼šæ¯”ä¾‹ã€ç¸®æ”¾ã€‚ç•¶ä¸€å€‹è®Šå¤§ï¼Œå¦ä¸€å€‹ä¹Ÿè¦è·Ÿè‘—è®Šå¤§ã€‚",
                icon: "ğŸ”",
                data: [
                    { q: "åšè›‹ç³•ï¼Œç³–å’Œæ°´çš„æ¯”ä¾‹å›ºå®šã€‚ç³–è®Š 2 å€ï¼Œæ°´ä¹Ÿè¦è®Šï¼Ÿ", type: "choice", options: ["2 å€", "ä¸€åŠ", "ä¸è®Š"], ans: 0 },
                    { q: "ç…§ç‰‡åŸæœ¬å¯¬ 10ï¼Œæ”¾å¤§å¾Œå¯¬è®Šæˆ 30ã€‚é€™æ˜¯æ”¾å¤§äº†å¹¾å€ï¼Ÿ", type: "input", ans: 3 },
                    { q: "å½±å°æ©Ÿæ”¾å¤§ 200%ã€‚åŸæœ¬é•·åº¦ 5 å…¬åˆ†çš„ç·šï¼Œæœƒè®Šæˆå¹¾å…¬åˆ†ï¼Ÿ", type: "input", ans: 10 },
                    { q: "ç…®é£¯æ™‚ï¼Œç±³è®Šå°‘äº†ä¸€åŠï¼Œæ°´ä¹Ÿè¦æ€éº¼è®Šï¼Œé£¯æ‰ä¸æœƒå¤ªä¹¾ï¼Ÿ", type: "choice", options: ["è®Šä¸€åŠ", "è®Š2å€", "ä¸è®Š"], ans: 0 },
                    { q: "æ¨¡å‹è»Šæ˜¯çœŸè»Šçš„ 1/10ã€‚çœŸè»Šé•· 300 å…¬åˆ†ï¼Œæ¨¡å‹è»Šé•·å¹¾å…¬åˆ†ï¼Ÿ", type: "input", ans: 30 },
                    { q: "æ—©ä¸Šçš„å½±å­æ¯”è¼ƒé•·ã€‚äººçš„é«˜åº¦ä¸è®Šï¼Œå¦‚æœå½±å­è®Šé•· 2 å€ï¼Œä»£è¡¨å¤ªé™½ç…§å°„è§’åº¦é€ æˆçš„æ¯”ä¾‹ï¼Ÿ", type: "choice", options: ["è®Šå¤§", "è®Šå°", "ä¸è®Š"], ans: 0 }, // æ¦‚å¿µé¡Œ
                    { q: "åœ°åœ–æ¯”ä¾‹å°º 1:100ã€‚åœ°åœ–ä¸Š 2 å…¬åˆ†ä»£è¡¨å¯¦éš›å¹¾å…¬åˆ†ï¼Ÿ", type: "input", ans: 200 }
                ]
            },
            4: {
                title: "ç¬¬å››é—œï½œç©ä¸è®Š",
                desc: "æ ¸å¿ƒè§€å¿µï¼šç¸½æ•¸å›ºå®šã€‚ä¸€å€‹è®Šå¤šï¼Œå¦ä¸€å€‹å°±è¦è®Šå°‘ (åæ¯”)ã€‚",
                icon: "ğŸ’°",
                data: [
                    { q: "é•·æ–¹å½¢é¢ç©å›ºå®šã€‚é•·è®Šç‚ºåŸæœ¬çš„ 2 å€ï¼Œå¯¬è¦è®Šæˆï¼Ÿ", type: "choice", options: ["2 å€", "ä¸€åŠ", "ä¸è®Š"], ans: 1 },
                    { q: "é–‹è»Šå»å°åŒ—ï¼Œæ™‚é€Ÿ 60 è¦é–‹ 2 å°æ™‚ã€‚æ™‚é€Ÿè®Š 120 (å¿«2å€)ï¼Œæ™‚é–“åªè¦å¹¾å°æ™‚ï¼Ÿ", type: "input", ans: 1 },
                    { q: "å·¥ç¨‹äººæ•¸è®Š 2 å€ï¼Œå·¥ä½œå¤©æ•¸æœƒï¼Ÿ", type: "choice", options: ["è®Šå°‘", "è®Šå¤š", "ä¸è®Š"], ans: 0 },
                    { q: "æœ‰ 100 å…ƒï¼Œè²· 10 å…ƒçš„ç­†å¯è²· 10 æã€‚è²· 20 å…ƒçš„ç­†åªèƒ½è²·å¹¾æï¼Ÿ", type: "input", ans: 5 },
                    { q: "ä¸€å€‹å¤§æ°´æ± ï¼Œç”¨ 1 æ ¹ç®¡å­æ³¨æ°´è¦ 12 å°æ™‚ã€‚ç”¨ 2 æ ¹ç®¡å­åªè¦å¹¾å°æ™‚ï¼Ÿ", type: "input", ans: 6 },
                    { q: "ä¸€æœ¬æ›¸ 300 é ã€‚æ¯å¤©çœ‹ 10 é è¦ 30 å¤©ã€‚æ¯å¤©çœ‹ 30 é åªè¦å¹¾å¤©ï¼Ÿ", type: "input", ans: 10 },
                    { q: "æŠ«è–©ç¸½é‡å›ºå®šã€‚åˆ†çµ¦ 4 å€‹äººåƒé£½ï¼Œå¦‚æœæ”¹æˆåˆ†çµ¦ 8 å€‹äººï¼Œæ¯äººåƒåˆ°çš„æœƒï¼Ÿ", type: "choice", options: ["è®Šå°‘", "è®Šå¤š", "ä¸è®Š"], ans: 0 }
                ]
            },
            5: {
                title: "ç¬¬äº”é—œï½œé›å…”å•é¡Œ",
                desc: "æ ¸å¿ƒè§€å¿µï¼šå‡è¨­æ³•åµæŸ¥ä»»å‹™ã€‚",
                icon: "ğŸ‡",
                type: "investigation",
                data: [
                    { 
                        story: "è¾²å ´æœ‰é›å’Œå…”å…± 10 éš»ï¼Œç®—ä¸€ç®—æœ‰ 28 éš»è…³ã€‚", 
                        totalHead: 10, totalLeg: 28, legA: 2, legB: 4, nameA: "é›", nameB: "å…”", unit: "éš»è…³"
                    },
                    { 
                        story: "åœè»Šå ´æœ‰æ±½è»Š(4è¼ª)å’Œæ©Ÿè»Š(2è¼ª)å…± 8 å°ï¼Œç®—ä¸€ç®—æœ‰ 26 å€‹è¼ªå­ã€‚", 
                        totalHead: 8, totalLeg: 26, legA: 2, legB: 4, nameA: "æ©Ÿè»Š", nameB: "æ±½è»Š", unit: "å€‹è¼ªå­"
                    },
                    { 
                        story: "éŠæ¨‚åœ’é–€ç¥¨ï¼Œå¤§äºº 10 å…ƒï¼Œå°å­© 5 å…ƒã€‚é€™åœ˜ 6 äººå…±èŠ±äº† 50 å…ƒã€‚", 
                        totalHead: 6, totalLeg: 50, legA: 5, legB: 10, nameA: "å°å­©ç¥¨", nameB: "å¤§äººç¥¨", unit: "å…ƒ"
                    },
                    {
                        story: "å­˜éŒ¢ç­’è£¡æœ‰ 10 å…ƒå’Œ 5 å…ƒç¡¬å¹£å…± 10 å€‹ï¼Œç¸½å…±æœ‰ 80 å…ƒã€‚",
                        totalHead: 10, totalLeg: 80, legA: 5, legB: 10, nameA: "5å…ƒ", nameB: "10å…ƒ", unit: "å…ƒ"
                    },
                    {
                        story: "æ± å¡˜è£¡æœ‰é¶´(2éš»è…³)å’Œçƒé¾œ(4éš»è…³)å…± 5 éš»ï¼Œå…±æœ‰ 16 éš»è…³ã€‚",
                        totalHead: 5, totalLeg: 16, legA: 2, legB: 4, nameA: "é¶´", nameB: "çƒé¾œ", unit: "éš»è…³"
                    }
                ]
            }
        };

        let state = { 
            playerName: "", 
            level: 1, 
            score: 0, 
            timer: 0, 
            timerInterval: null, 
            currentQIndex: 0, 
            questionQueue: [], // æ–°å¢ï¼šç”¨ä¾†å­˜éš¨æ©Ÿæ’åºå¾Œçš„é¡Œç›®
            isPaused: false, 
            difficulty: 'normal', 
            investigationStep: 0 
        };

        const screens = { login: document.getElementById('screen-login'), select: document.getElementById('screen-level-select'), game: document.getElementById('screen-game'), result: document.getElementById('screen-result') };
        const modals = { intro: document.getElementById('modal-intro'), pause: document.getElementById('modal-pause') };

        // --- ç•«é¢åˆ‡æ› ---
        function showScreen(name) { 
            Object.values(screens).forEach(s => s.classList.add('hidden')); 
            if(screens[name]) screens[name].classList.remove('hidden');
        }
        
        function checkNameAndStart() { 
            const nameInput = document.getElementById('player-name').value.trim();
            if(!nameInput){ alert("è«‹è¼¸å…¥åå­—ï¼"); return; } 
            state.playerName = nameInput; 
            showScreen('select'); 
            renderLeaderboardTab(1); 
        }

        // --- æ´—ç‰Œæ¼”ç®—æ³• (Fisher-Yates Shuffle) ---
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            // ç•¶é‚„æœ‰å…ƒç´ æœªæ´—ç‰Œæ™‚
            while (currentIndex != 0) {
                // éš¨æ©Ÿé¸å–ä¸€å€‹å…ƒç´ 
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // äº¤æ›å®ƒèˆ‡ç•¶å‰å…ƒç´ 
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- æ’è¡Œæ¦œé‚è¼¯ ---
        function renderLeaderboardTab(lvl) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${lvl}`);
            if(tabBtn) tabBtn.classList.add('active');

            const key = `jessie_math_lb_level_${lvl}`;
            let lb = [];
            try { lb = JSON.parse(localStorage.getItem(key) || "[]"); } catch (e) { lb = []; }
            
            const listEl = document.getElementById('select-screen-lb-list');
            if(!listEl) return;
            
            if(lb.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-400 py-8">ç›®å‰é‚„æ²’æœ‰äººæŒ‘æˆ°é€™é—œï¼Œå¿«ä¾†æ¶ç¬¬ä¸€åï¼</div>`;
                return;
            }

            listEl.innerHTML = lb.map((p, i) => `
                <div class="flex justify-between items-center p-3 mb-2 rounded-lg ${i===0?'bg-yellow-50 border border-yellow-200':'bg-gray-50'}">
                    <div class="flex items-center gap-3">
                        <span class="font-bold w-6 ${i<3 ? 'text-yellow-500':'text-gray-400'} text-lg">#${i+1}</span>
                        <span class="font-bold text-gray-700">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-500"><i class="fa-regular fa-clock"></i> ${formatTime(p.time)}</span>
                        <span class="text-orange-500 font-bold text-lg">${p.score}åˆ†</span>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            return `${m}:${s}`;
        }

        // --- éŠæˆ²æµç¨‹ ---
        function selectLevel(lvl) { 
            state.level = lvl; 
            const c = levels[lvl]; 
            if(!c) return;
            document.getElementById('intro-title').innerText = c.title; 
            document.getElementById('intro-icon').innerText = c.icon; 
            document.getElementById('intro-desc').innerHTML = c.desc; 
            modals.intro.classList.remove('hidden'); 
        }

        function closeIntro() { modals.intro.classList.add('hidden'); }

        function startGame(diff) { 
            state.difficulty = diff; 
            closeIntro(); 
            showScreen('game'); 
            
            // é‡è¦ï¼šé€™è£¡é€²è¡Œé¡Œç›®æ´—ç‰Œ
            // å…ˆæ·±æ‹·è²é¡Œç›®é™£åˆ—ï¼Œä»¥å…å½±éŸ¿åŸå§‹è³‡æ–™
            const originalData = levels[state.level].data;
            let pool = JSON.parse(JSON.stringify(originalData));
            
            // åŸ·è¡Œéš¨æ©Ÿæ’åº
            state.questionQueue = shuffleArray(pool);

            resetGameState(); 
            startTimer(); 
            loadQuestion(); 
        }

        function resetGameState() { 
            state.score = 0; 
            state.timer = 0; 
            state.currentQIndex = 0; 
            state.isPaused = false; 
            state.investigationStep = 0; 
            updateUI(); 
        }

        function startTimer() { 
            clearInterval(state.timerInterval); 
            state.timerInterval = setInterval(() => { 
                if(!state.isPaused) { 
                    state.timer++; 
                    updateUI(); 
                } 
            }, 1000); 
        }

        function updateUI() { 
            document.getElementById('game-timer').innerText = formatTime(state.timer); 
            document.getElementById('game-score').innerText = state.score; 
        }

        function pauseGame() { state.isPaused = true; modals.pause.classList.remove('hidden'); }
        function resumeGame() { state.isPaused = false; modals.pause.classList.add('hidden'); }
        function quitGame() { clearInterval(state.timerInterval); modals.pause.classList.add('hidden'); showScreen('select'); renderLeaderboardTab(state.level); }
        function restartLevel() { 
            // é‡æ–°é–‹å§‹æ™‚ï¼Œé‡æ–°éš¨æ©Ÿä¸€æ¬¡é¡Œç›®
            startGame(state.difficulty); 
        }
        function goHome() { window.location.href = "https://jessiemath0703-chu.github.io/website2/"; }

        // --- è¼‰å…¥é¡Œç›® ---
        function loadQuestion() {
            const config = levels[state.level];
            
            // æ”¹ç‚ºå¾éš¨æ©Ÿä½‡åˆ—ä¸­è®€å–é¡Œç›®
            const qData = state.questionQueue[state.currentQIndex];
            
            const qArea = document.getElementById('question-content');
            const cArea = document.getElementById('controls-area');
            
            // é€²åº¦æ¢
            const total = state.questionQueue.length || 1;
            const progress = ((state.currentQIndex) / total) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            qArea.innerHTML = ''; 
            cArea.innerHTML = ''; 
            cArea.className = "mt-4 grid grid-cols-1 md:grid-cols-2 gap-4";

            if (!qData) { endGame(); return; }

            if (config.type === 'investigation') { renderInvestigation(qData, qArea, cArea); return; }

            qArea.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-gray-800">${qData.q}</h3>`;

            if (qData.type === 'choice') {
                qData.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-4 px-6 rounded-xl transition duration-200 transform active:scale-95 text-lg w-full";
                    btn.innerText = opt;
                    btn.onclick = (e) => checkAnswer(idx, qData.ans, e.target);
                    cArea.appendChild(btn);
                });
            } else if (qData.type === 'input') {
                cArea.className = "mt-4 flex flex-col items-center gap-4 w-full";
                const input = document.createElement('input');
                input.type = "number";
                input.className = "border-2 border-gray-300 rounded-lg px-4 py-2 text-2xl text-center w-32";
                input.placeholder = "?";
                
                const btn = document.createElement('button');
                btn.className = "btn-primary w-full md:w-auto";
                btn.innerText = "ç¢ºèªç­”æ¡ˆ";
                btn.onclick = () => checkAnswer(parseInt(input.value), qData.ans, btn);
                
                cArea.appendChild(input);
                cArea.appendChild(btn);
            }
        }

        function renderInvestigation(data, qArea, cArea) {
            const unit = data.unit || "å€‹å–®ä½";
            const steps = [
                {
                    text: `æ¡ˆä»¶ï¼š${data.story}<br>ğŸ‘‰ ç¬¬ä¸€æ­¥ï¼šå…ˆå‡è¨­å…¨éƒ¨éƒ½æ˜¯ã€Œ${data.nameA}ã€ï¼`,
                    actionText: `è‹¥æ˜¯ ${data.totalHead} å€‹${data.nameA}ï¼Œå…±æœ‰å¤šå°‘${unit}ï¼Ÿ`,
                    inputType: 'number', check: (v) => parseInt(v) === data.totalHead * data.legA,
                    failMsg: `ç®—éŒ¯å›‰ï¼${data.totalHead} x ${data.legA} æ˜¯å¤šå°‘ï¼Ÿ`
                },
                {
                    text: `å‡è¨­å…¨æ˜¯${data.nameA}ï¼Œæœƒæœ‰ ${data.totalHead * data.legA} ${unit}ã€‚<br>ä½†ç¾å ´å¯¦éš›æœ‰ ${data.totalLeg} ${unit}ã€‚<br>ğŸ‘‰ ç¬¬äºŒæ­¥ï¼šæˆ‘å€‘å°‘äº†(æˆ–å¤šäº†)å¤šå°‘${unit}ï¼Ÿ`,
                    actionText: `å·®è·æ˜¯ï¼š ${data.totalLeg} èˆ‡ ${data.totalHead * data.legA} ç›¸æ¸›(å–æ­£æ•¸) = ?`,
                    inputType: 'number', check: (v) => parseInt(v) === Math.abs(data.totalLeg - (data.totalHead * data.legA)),
                    failMsg: "ç›¸æ¸›ç®—éŒ¯å›‰ï¼Œå†è©¦ä¸€æ¬¡ã€‚"
                },
                {
                    text: `ç¸½å·®è·æ˜¯ ${Math.abs(data.totalLeg - (data.totalHead * data.legA))}ã€‚<br>ğŸ‘‰ ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæŠŠä¸€å€‹${data.nameA}æ›æˆ${data.nameB}ï¼Œ${unit}æœƒå·®å¤šå°‘ï¼Ÿ`,
                    actionText: `${data.nameB}(${data.legB}) èˆ‡ ${data.nameA}(${data.legA}) å·®å¤šå°‘ï¼Ÿ`,
                    inputType: 'number', check: (v) => parseInt(v) === Math.abs(data.legB - data.legA),
                    failMsg: "æ¯æ›ä¸€å€‹ï¼Œæœƒå·®å¤šå°‘å‘¢ï¼Ÿ"
                },
                {
                    text: `ç¸½å…±å·® ${Math.abs(data.totalLeg - (data.totalHead * data.legA))}ï¼Œæ¯æ›ä¸€å€‹è£œ ${Math.abs(data.legB - data.legA)}ã€‚<br>ğŸ‘‰ ç¬¬å››æ­¥ï¼šæ‰€ä»¥æœ‰å¹¾å€‹${data.nameB}ï¼Ÿ`,
                    actionText: `ç¸½å·®è· Ã· å–®å€‹å·®è· = ?`,
                    inputType: 'number', check: (v) => parseInt(v) === Math.abs(data.totalLeg - (data.totalHead * data.legA)) / Math.abs(data.legB - data.legA),
                    failMsg: "é™¤æ³•ç®—éŒ¯å›‰ï¼"
                }
            ];

            const currentStep = steps[state.investigationStep];
            qArea.innerHTML = `<div class="w-full text-left space-y-2"><div class="bg-gray-50 p-3 rounded text-gray-500 text-sm mb-2">ğŸ•µï¸ æ¡ˆä»¶é‡è¿°ï¼š${data.story}</div><div class="step-card"><p class="font-bold text-lg">${currentStep.text}</p></div></div>`;
            
            cArea.className = "mt-4 flex flex-col w-full";
            const wrapper = document.createElement('div');
            wrapper.className = "bg-blue-50 p-4 rounded-xl flex flex-col items-center gap-3 w-full";
            wrapper.innerHTML = `<label class="font-bold text-blue-800 text-center">${currentStep.actionText}</label>`;
            const input = document.createElement('input'); input.type = "number"; input.className = "border-2 border-blue-300 rounded-lg px-4 py-2 text-xl text-center w-full max-w-xs";
            const btn = document.createElement('button'); btn.className = "btn-primary w-full max-w-xs"; btn.innerText = "é€å‡º";
            
            btn.onclick = () => {
                if (currentStep.check(input.value)) {
                    state.investigationStep++; state.score += 10; updateUI();
                    if (state.investigationStep >= steps.length) {
                        alert(`èª¿æŸ¥æˆåŠŸï¼ç­”æ¡ˆå°±æ˜¯ ${input.value} å€‹${data.nameB}ï¼`);
                        state.investigationStep = 0; state.currentQIndex++; loadQuestion();
                    } else { loadQuestion(); }
                } else { alert(`âŒ ${currentStep.failMsg}`); state.timer += 5; updateUI(); }
            };
            wrapper.appendChild(input); wrapper.appendChild(btn); cArea.appendChild(wrapper);
        }

        function checkAnswer(userAns, correctAns, targetBtn) {
            if (userAns == correctAns) {
                state.score += (state.difficulty === 'fast' ? 150 : 100); 
                state.currentQIndex++;
                if(targetBtn && targetBtn.tagName === 'BUTTON') { 
                    targetBtn.classList.remove('bg-blue-100','text-blue-800'); 
                    targetBtn.classList.add('bg-green-500','text-white'); 
                }
                setTimeout(loadQuestion, 500);
            } else { 
                alert("å†æƒ³ä¸€æƒ³å–”ï¼"); 
                state.timer += 10; 
                updateUI(); 
            }
        }

        function endGame() {
            clearInterval(state.timerInterval); 
            showScreen('result');
            document.getElementById('result-name').innerText = state.playerName; 
            document.getElementById('result-score').innerText = state.score;
            document.getElementById('result-time').innerText = formatTime(state.timer);
            
            const key = `jessie_math_lb_level_${state.level}`; 
            let lb = JSON.parse(localStorage.getItem(key) || "[]");
            lb.push({ name: state.playerName, score: state.score, time: state.timer });
            lb.sort((a, b) => b.score - a.score || a.time - b.time); 
            lb = lb.slice(0, 5);
            localStorage.setItem(key, JSON.stringify(lb));
        }
    </script>
</body>
</html>